# Studentia Backend (Consent)

Express + TypeScript API for consent grant/revoke with Algorand app calls and optional AES-GCM encryption. This is the backend your teammate can run via Live Share.

## Quick start (dev)
```sh
cd projects/Studentia-backend
npm install
npm run dev   # uses nodemon + tsx, watches src/*
```

## Env vars (create .env)
- `APP_ID` (required): Algorand app ID
- `ALGOD_SERVER` / `ALGOD_PORT` / `ALGOD_TOKEN` (required): Algod endpoint (e.g., Testnet Algonode)
- `SIGNER_MNEMONIC` (required): account that signs app calls
- `DATA_ENC_KEY` (optional): base64 32-byte key for AES-GCM encrypting stored blobs
- `MONGODB_URI` (required): Mongo connection string for document storage
- `API_TOKEN` (optional): bearer token to protect the API
- `API_PORT` (optional): default 3000

Example .env
```
APP_ID=1002
ALGOD_SERVER=https://testnet-api.algonode.cloud
ALGOD_PORT=443
ALGOD_TOKEN=
SIGNER_MNEMONIC="word1 word2 ... word25"
DATA_ENC_KEY=base64-32-byte-key-here
MONGODB_URI=mongodb://127.0.0.1:27017/studentia
API_TOKEN=devtoken
API_PORT=3000
```

## API endpoints
- `GET /health` → `{ ok: true }`
- `GET /data-groups/:studentId` → list default + custom data groups for student
- `POST /data-groups` → create custom data group for student
- `POST /consents/grant` → body `{ studentId, receiverGroup, dataGroup, dataBlob? }` → `{ ok, txId, returnValue }`
- `POST /consents/revoke` → body `{ studentId, receiverGroup, dataGroup }` → `{ ok, txId, returnValue }`
- `GET /consents/:studentId` → `{ ok, records: [...] }`
- `POST /documents/upload` → upload/store base64 payload in Mongo
- `POST /documents/upload-form` → upload/store file via multipart form-data in Mongo
- `GET /documents/:studentId` → list document metadata
- `GET /documents/:studentId/grouped` → list documents grouped by `dataGroup`
- `POST /documents/:id/share` → share only if on-chain consent is granted
- `GET /documents/download/:id` → retrieve stored payload (owner/shared access rules)
- `POST /access-requests` → requester creates a pending access request
- `GET /access-requests/student/:studentId` → student inbox
- `POST /access-requests/:id/approve` → approve request + auto-grant on-chain consent
- `POST /access-requests/:id/reject` → reject request

Full request/response examples: see `API_REFERENCE.md`.

Frontend handoff docs for file upload + data-group flow: see `FRONTEND_FILE_FLOW_GUIDE.md`.

Auth: if `API_TOKEN` is set, include header `Authorization: Bearer <API_TOKEN>`.

## Postman test flow
1) Start API: `npm run dev` (ensure env is set).
2) POST http://localhost:3000/consents/grant with JSON body and bearer if enabled → expect `txId`.
3) POST http://localhost:3000/consents/revoke with same fields → expect `txId`.
4) GET http://localhost:3000/consents/<studentId> → see stored records (in-memory).

## Frontend wiring (Studentia-frontend)
- Set `VITE_API_BASE=http://localhost:3000` (and `VITE_API_TOKEN` if using auth) in `.env`.
- AppCalls will use the backend when `VITE_API_BASE` is present; otherwise it falls back to wallet-signed direct contract calls.

## Notes
- Storage: in-memory record store (hackathon-friendly). For production, swap to SQLite/DB.
- Encryption: optional AES-GCM via `DATA_ENC_KEY` for any `dataBlob` payload.
- Signing: backend signs with `SIGNER_MNEMONIC`; frontend wallet is optional when using backend path.
