# Studentia Consent API Reference

Base URL (local): `http://localhost:3000`

Auth:
- Currently auth is disabled in backend middleware for local development.
- If re-enabled later, send: `Authorization: Bearer <API_TOKEN>`.

## 1) Health
### Request
`GET /health`

### Example response
```json
{
  "ok": true
}
```

## 2) Grant consent
### Request
`POST /consents/grant`

Body:
```json
{
  "studentId": "student-001",
  "receiverGroup": "Recruiters",
  "dataGroup": "Portfolio",
  "dataBlob": "optional payload"
}
```

### Example response
```json
{
  "ok": true,
  "txId": "KQ6...ABC",
  "returnValue": "GRANTED:student-001:Recruiters:Portfolio"
}
```

## 3) Revoke consent
### Request
`POST /consents/revoke`

Body:
```json
{
  "studentId": "student-001",
  "receiverGroup": "Recruiters",
  "dataGroup": "Portfolio"
}
```

### Example response
```json
{
  "ok": true,
  "txId": "Y7T...XYZ",
  "returnValue": "REVOKED:student-001:Recruiters:Portfolio"
}
```

## 4) Backend in-memory records for a student
### Request
`GET /consents/:studentId`

### Example
`GET /consents/student-001`

### Example response
```json
{
  "ok": true,
  "records": [
    {
      "studentId": "student-001",
      "receiverGroup": "Recruiters",
      "dataGroup": "Portfolio",
      "status": "granted",
      "txId": "KQ6...ABC"
    }
  ]
}
```

## 5) On-chain status for one tuple
### Request
`GET /consents/onchain/:studentId/:receiverGroup/:dataGroup`

### Example
`GET /consents/onchain/student-001/Recruiters/Portfolio`

### Example response
```json
{
  "ok": true,
  "boxKey": "student-001:Recruiters:Portfolio",
  "status": "granted",
  "numeric": 1
}
```

Status meanings:
- `granted` → `numeric: 1`
- `revoked` → `numeric: 0`
- `none` → box missing

## 6) Bulk on-chain status for one student
### Request
`GET /consents/onchain/:studentId`

### Example
`GET /consents/onchain/student-001`

### Example response
```json
{
  "ok": true,
  "statuses": [
    {
      "studentId": "student-001",
      "receiverGroup": "Recruiters",
      "dataGroup": "Portfolio",
      "boxKey": "student-001:Recruiters:Portfolio",
      "status": "granted",
      "numeric": 1
    }
  ]
}
```

## 7) Upload document (MongoDB)
### Request
`POST /documents/upload`

Body:
```json
{
  "studentId": "student-001",
  "receiverGroup": "Recruiters",
  "dataGroup": "Portfolio",
  "fileName": "resume.pdf",
  "mimeType": "application/pdf",
  "fileBase64": "JVBERi0xLjc..."
}
```

## 7b) Upload document via multipart/form-data
### Request
`POST /documents/upload-form`

Form fields:
- `studentId` (text)
- `receiverGroup` (text)
- `dataGroup` (text)
- `file` (file)

### cURL example
```bash
curl -X POST http://localhost:3000/documents/upload-form \
  -F "studentId=student-001" \
  -F "receiverGroup=Recruiters" \
  -F "dataGroup=Portfolio" \
  -F "file=@./resume.pdf"
```

### Example response
```json
{
  "ok": true,
  "document": {
    "id": "67b7...",
    "studentId": "student-001",
    "receiverGroup": "Recruiters",
    "dataGroup": "Portfolio",
    "fileName": "resume.pdf",
    "mimeType": "application/pdf",
    "sizeBytes": 23456,
    "storageMode": "encrypted",
    "sharedWith": [],
    "createdAt": "2026-02-20T..."
  }
}
```

### Example response
```json
{
  "ok": true,
  "document": {
    "id": "67b7...",
    "studentId": "student-001",
    "receiverGroup": "Recruiters",
    "dataGroup": "Portfolio",
    "fileName": "resume.pdf",
    "mimeType": "application/pdf",
    "sizeBytes": 23456,
    "storageMode": "encrypted",
    "sharedWith": [],
    "createdAt": "2026-02-20T..."
  }
}
```

## 8) List documents by student
### Request
`GET /documents/:studentId`

### Example
`GET /documents/student-001`

### Example response
```json
{
  "ok": true,
  "documents": [
    {
      "id": "67b7...",
      "studentId": "student-001",
      "receiverGroup": "Recruiters",
      "dataGroup": "Portfolio",
      "fileName": "resume.pdf",
      "mimeType": "application/pdf",
      "sizeBytes": 23456,
      "storageMode": "encrypted",
      "sharedWith": [],
      "createdAt": "2026-02-20T..."
    }
  ]
}
```

## 9) Share document with receiver group (consent-gated)
### Request
`POST /documents/:id/share`

Body:
```json
{
  "studentId": "student-001",
  "receiverGroup": "Recruiters"
}
```

### Example response
```json
{
  "ok": true,
  "id": "67b7...",
  "sharedWith": ["Recruiters"],
  "onChainStatus": "granted"
}
```

## 10) Download document payload
### Request
`GET /documents/download/:id?ownerStudentId=student-001&requesterGroup=Recruiters`

Notes:
- For owner access, pass only `ownerStudentId`.
- For shared access, pass `ownerStudentId` and `requesterGroup`.

### Example response
```json
{
  "ok": true,
  "document": {
    "id": "67b7...",
    "studentId": "student-001",
    "receiverGroup": "Recruiters",
    "dataGroup": "Portfolio",
    "fileName": "resume.pdf",
    "mimeType": "application/pdf",
    "sizeBytes": 23456
  },
  "fileBase64": "JVBERi0xLjc...",
  "accessMode": "shared"
}
```

## 11) Create access request
### Request
`POST /access-requests`

Body:
```json
{
  "studentId": "student-001",
  "requesterGroup": "Recruiters",
  "dataGroup": "Portfolio",
  "purpose": "Screening"
}
```

### Example response
```json
{
  "ok": true,
  "request": {
    "id": "67b8...",
    "studentId": "student-001",
    "requesterGroup": "Recruiters",
    "dataGroup": "Portfolio",
    "purpose": "Screening",
    "status": "pending",
    "createdAt": "2026-02-20T..."
  }
}
```

## 12) List access requests by student
### Request
`GET /access-requests/student/:studentId`

## 13) List access requests by requester group
### Request
`GET /access-requests/requester/:requesterGroup`

## 14) Approve access request (auto-grants on-chain consent)
### Request
`POST /access-requests/:id/approve`

### Example response
```json
{
  "ok": true,
  "request": {
    "id": "67b8...",
    "studentId": "student-001",
    "requesterGroup": "Recruiters",
    "dataGroup": "Portfolio",
    "status": "approved",
    "approvedTxId": "ABC...",
    "approvedReturnValue": "GRANTED:student-001:Recruiters:Portfolio"
  }
}
```

## 15) Reject access request
### Request
`POST /access-requests/:id/reject`

Body:
```json
{
  "reason": "Not needed"
}
```

## PowerShell test commands
```powershell
# 1) Health
Invoke-WebRequest -Uri http://localhost:3000/health -UseBasicParsing | Select-Object -ExpandProperty Content

# 2) Grant
Invoke-WebRequest -Uri http://localhost:3000/consents/grant -Method POST -ContentType 'application/json' -Body '{"studentId":"student-001","receiverGroup":"Recruiters","dataGroup":"Portfolio"}' -UseBasicParsing | Select-Object -ExpandProperty Content

# 3) Revoke
Invoke-WebRequest -Uri http://localhost:3000/consents/revoke -Method POST -ContentType 'application/json' -Body '{"studentId":"student-001","receiverGroup":"Recruiters","dataGroup":"Portfolio"}' -UseBasicParsing | Select-Object -ExpandProperty Content

# 4) Backend records
Invoke-WebRequest -Uri http://localhost:3000/consents/student-001 -UseBasicParsing | Select-Object -ExpandProperty Content

# 5) On-chain exact tuple
Invoke-WebRequest -Uri http://localhost:3000/consents/onchain/student-001/Recruiters/Portfolio -UseBasicParsing | Select-Object -ExpandProperty Content

# 6) On-chain bulk
Invoke-WebRequest -Uri http://localhost:3000/consents/onchain/student-001 -UseBasicParsing | Select-Object -ExpandProperty Content

# 7) Upload sample text file as base64
$b64 = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes('hello-studentia'))
Invoke-WebRequest -Uri http://localhost:3000/documents/upload -Method POST -ContentType 'application/json' -Body ("{\"studentId\":\"student-001\",\"receiverGroup\":\"Recruiters\",\"dataGroup\":\"Portfolio\",\"fileName\":\"hello.txt\",\"mimeType\":\"text/plain\",\"fileBase64\":\"$b64\"}") -UseBasicParsing | Select-Object -ExpandProperty Content

# 7b) Upload file as multipart form-data
curl.exe -X POST http://localhost:3000/documents/upload-form -F "studentId=student-001" -F "receiverGroup=Recruiters" -F "dataGroup=Portfolio" -F "file=@D:/path/to/hello.txt"

# 8) List docs
Invoke-WebRequest -Uri http://localhost:3000/documents/student-001 -UseBasicParsing | Select-Object -ExpandProperty Content

# 9) Share doc (replace <DOC_ID>)
Invoke-WebRequest -Uri http://localhost:3000/documents/<DOC_ID>/share -Method POST -ContentType 'application/json' -Body '{"studentId":"student-001","receiverGroup":"Recruiters"}' -UseBasicParsing | Select-Object -ExpandProperty Content

# 10) Download shared doc (replace <DOC_ID>)
Invoke-WebRequest -Uri http://localhost:3000/documents/download/<DOC_ID>?ownerStudentId=student-001&requesterGroup=Recruiters -UseBasicParsing | Select-Object -ExpandProperty Content

# 11) Create access request
Invoke-WebRequest -Uri http://localhost:3000/access-requests -Method POST -ContentType 'application/json' -Body '{"studentId":"student-001","requesterGroup":"Recruiters","dataGroup":"Portfolio","purpose":"Screening"}' -UseBasicParsing | Select-Object -ExpandProperty Content

# 12) List student inbox
Invoke-WebRequest -Uri http://localhost:3000/access-requests/student/student-001 -UseBasicParsing | Select-Object -ExpandProperty Content

# 13) Approve request (replace <REQ_ID>)
Invoke-WebRequest -Uri http://localhost:3000/access-requests/<REQ_ID>/approve -Method POST -UseBasicParsing | Select-Object -ExpandProperty Content
```

## Troubleshooting
- `Invalid API Token`: set backend `.env` `ALGOD_TOKEN` to LocalNet value.
- `invalid Box reference`: backend/frontend must send the same tuple values used for the box key.
- `Unable to connect`: backend not running on port 3000.
